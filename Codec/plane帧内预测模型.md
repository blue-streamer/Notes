在帧内预测中，有一种plane预测模型。一般用于较为平坦的16x16块的帧内预测。公式如下:
$$
pred[x,y] = (a + b*(x-7) + c*(y-7) + 16) >> 5，x,y=0...15\\
$$
其中，a，b，c如下：
$$
\begin{aligned}
&a = 16*(p[-1,15] + p[15,-1])\\
&b = (5*H + 32)>>6\\
&c = (5*V + 32)>>6
\end{aligned}
$$
H，V如下计算：
$$
H = \sum_{x=0}^7(x+1)*(p[8+x, -1] - p[6-x, -1])\\
V = \sum_{y=0}^7(y+1)*(p[-1, 8+y] - p[-1, 6-y])
$$
其中$pred[x,y]$是指预测值，$p[x,y]$是指重构图像的像素值。$p[x,-1]，x=0...15$表示当前16x16块的top line重构像素，$p[-1,y], y=0...15$表示当前16x16的块left line重构像素。

这个公式看上去并不直观，可以把待编码的16x16的块的像素值理解为一个坐标的二元函数f(x,y)。而plane的预测方法是**对f(x,y)在(7,7)这一点的一阶泰勒展开**。

重写plane预测公式：
$$
pred[x,y] = \frac{p[-1,15]+p[15,-1]}{2} + \frac{5H}{2048}*(x-7) + \frac{5V}{2048}*(y-7)
$$
公式中的“+16”和“+32”是移位的四舍五入处理，可以先忽略不计。

可以看到(p[-1,15]+p[15,-1])/2可以理解为通过已经重构的像素值对p[7,7]的预测，当x=7,y=7时，pred[x,y]就是两个像素的均值。根据泰勒展开的公式，$5H/2048$和$5V/2048$应该是f(x,y)在(7,7)这个一点的x方向和y方向的一阶导数。

以H为例，这个一阶导数是通过top line中的像素，在以x=7的位置为中心的像素点计算梯度，然后加权得到的。简化表示，p[x,-1]使用px来表示。首先来写出梯度的计算：
$$
gradX = a_1*\frac{p_8-p_6}{2} + a_2*\frac{p_9-p_5}{4} + ... +a_8*\frac{p_{15}-p_{-1}}{16}
$$
其中$a_n$是梯度的权重。

根据H的计算公式易得，权重之间的比例应该是**计算梯度的两个点之间的距离的平方**：
$$
a_x = \frac{x^2}{\sum_{n=1}^8n^2}=\frac{x^2}{204}
$$
因此，梯度的计算公式为：
$$
gradX = \frac{(p_8-p_6)+2(p_9-p_5)+...+8(P_{15}-p_{-1})}{408}=\frac{H}{408}
$$
为了方便使用移位计算，有如下近似: 
$$
5*408 = 2040 \approx2048
$$
因此:
$$
gradX \approx \frac{5H}{2048}\\
gradY \approx \frac{5V}{2048}
$$

